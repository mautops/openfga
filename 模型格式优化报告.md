# OpenFGA 模型格式优化报告

## 优化时间
2026-02-05

## 问题描述

在集成示例中发现使用了 JSON 格式的授权模型文件，这种格式对人类不友好：
- 冗长复杂，难以阅读
- 嵌套层次深，容易出错
- 不适合人工编辑和维护
- 难以进行代码审查

## 优化措施

### 1. 删除 JSON 格式模型文件

已删除以下 JSON 格式的模型文件：
- ✅ `integrates/01.python-sdk-basic/authorization_model.json`
- ✅ `integrates/03.fastapi-integration/authorization_model.json`

### 2. 创建 .fga DSL 格式模型

创建了人类友好的 `.fga` 格式模型文件：
- ✅ `integrates/01.python-sdk-basic/authorization_model.fga`

**DSL 格式示例**:
```fga
model
  schema 1.1

type user

type document
  relations
    define owner: [user]
    define editor: [user]
    define viewer: [user] or editor or owner
```

### 3. 创建格式说明文档

创建了 `MODEL_FORMAT.md` 文档，详细说明：
- ✅ 为什么推荐使用 .fga 格式
- ✅ JSON 格式的缺点
- ✅ 如何使用 .fga 文件
- ✅ 格式对比示例
- ✅ 最佳实践建议

## 格式对比

### 简单模型对比

**DSL 格式** (5 行，清晰易读):
```fga
type user

type document
  relations
    define owner: [user]
```

**JSON 格式** (20+ 行，复杂难读):
```json
{
  "schema_version": "1.1",
  "type_definitions": [
    {
      "type": "user",
      "relations": {},
      "metadata": {"relations": {}}
    },
    {
      "type": "document",
      "relations": {
        "owner": {"this": {}}
      },
      "metadata": {
        "relations": {
          "owner": {
            "directly_related_user_types": [
              {"type": "user"}
            ]
          }
        }
      }
    }
  ]
}
```

### 复杂模型对比

**DSL 格式** (简洁):
```fga
type document
  relations
    define owner: [user]
    define editor: [user]
    define viewer: [user] or editor or owner
```

**JSON 格式** (冗长):
```json
{
  "type": "document",
  "relations": {
    "owner": {"this": {}},
    "editor": {"this": {}},
    "viewer": {
      "union": {
        "child": [
          {"this": {}},
          {"computedUserset": {"relation": "editor"}},
          {"computedUserset": {"relation": "owner"}}
        ]
      }
    }
  },
  "metadata": {
    "relations": {
      "owner": {"directly_related_user_types": [{"type": "user"}]},
      "editor": {"directly_related_user_types": [{"type": "user"}]},
      "viewer": {"directly_related_user_types": [{"type": "user"}]}
    }
  }
}
```

## .fga 格式的优势

### 1. 可读性
- ✅ 清晰的缩进结构
- ✅ 简洁的语法
- ✅ 接近自然语言
- ✅ 易于理解关系定义

### 2. 可维护性
- ✅ 易于编辑和修改
- ✅ 支持注释
- ✅ 减少语法错误
- ✅ 便于版本控制

### 3. 协作友好
- ✅ 代码审查更容易
- ✅ 团队成员快速理解
- ✅ 降低学习成本
- ✅ 提高开发效率

### 4. 工具支持
- ✅ fga CLI 原生支持
- ✅ VSCode 扩展支持
- ✅ 语法高亮
- ✅ 自动补全

## 使用建议

### 开发流程

1. **编写模型**：使用 .fga 格式
   ```bash
   vim authorization_model.fga
   ```

2. **验证语法**：使用 fga CLI
   ```bash
   fga model validate --file authorization_model.fga
   ```

3. **写入 OpenFGA**：
   ```bash
   fga model write --store-id <store-id> --file authorization_model.fga
   ```

4. **版本控制**：提交到 Git
   ```bash
   git add authorization_model.fga
   git commit -m "更新授权模型"
   ```

### 代码集成

在 Python 代码中使用 .fga 文件：

```python
# 读取 .fga 文件
with open('authorization_model.fga', 'r') as f:
    model_dsl = f.read()

# 使用 fga CLI 转换为 JSON（如果需要）
import subprocess
result = subprocess.run(
    ['fga', 'model', 'transform', '--file', 'authorization_model.fga', '--output-format', 'json'],
    capture_output=True,
    text=True
)
model_json = result.stdout
```

## 项目现状

### models 目录
- ✅ 所有 48 个模型都使用 .fga 格式
- ✅ 格式统一，易于维护
- ✅ 测试全部通过

### integrates 目录
- ✅ 已删除所有 JSON 格式模型
- ✅ 使用 .fga 格式
- ✅ 添加了格式说明文档

## 最佳实践总结

1. **始终使用 .fga DSL 格式**编写授权模型
2. **JSON 格式仅用于 API 传输**，不用于人工编辑
3. **使用 fga CLI 工具**进行模型管理
4. **添加注释**说明复杂的关系定义
5. **版本控制**.fga 文件
6. **代码审查**模型变更
7. **自动化测试**验证模型语法

## 相关文档

- `integrates/01.python-sdk-basic/MODEL_FORMAT.md` - 详细的格式说明
- `integrates/01.python-sdk-basic/authorization_model.fga` - 示例模型
- [OpenFGA 模型语法文档](https://openfga.dev/docs/modeling/language)
- [fga CLI 文档](https://github.com/openfga/cli)

## 总结

✅ **已完成**:
- 删除所有 JSON 格式的授权模型文件
- 使用人类友好的 .fga DSL 格式
- 创建详细的格式说明文档
- 统一项目中的模型格式

✅ **优势**:
- 提高可读性和可维护性
- 降低学习成本
- 提升团队协作效率
- 减少错误发生

✅ **建议**:
- 在所有文档和示例中推荐使用 .fga 格式
- 在代码审查中检查模型格式
- 使用 fga CLI 工具进行模型管理

现在整个项目都使用人类友好的 .fga DSL 格式，大大提升了可读性和可维护性！
