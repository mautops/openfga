# 第 5 章：授权模型设计

从零开始设计一个灵活、可扩展的授权模型

---

第一次设计授权模型时，我盯着空白的编辑器发呆了半小时——到底该从哪里开始？定义哪些类型？关系怎么设计？权限如何继承？

这些问题，你可能也会遇到。

本章将带你从零开始设计授权模型——从最简单的文档权限到复杂的多租户系统，从基础语法到高级模式。读完本章，你不仅能独立设计授权模型,更能利用 AI 工具大幅提升开发效率。

## 5.1 授权模型基础

授权模型是 OpenFGA 的核心——它定义了系统中的实体类型、关系规则和权限计算方式。

### 模型的本质

授权模型就像数据库的 schema，它定义了"可以有什么类型和关系"，而关系元组则是"具体存在哪些关系"。

一个授权模型包含三个核心要素：

**类型（Type）** - 系统中的实体类别，如 user、document、folder。类型定义了系统中可以存在哪些实体。

**关系（Relation）** - 实体之间的关联方式，如 owner、editor、viewer。关系定义了实体之间可以建立哪些连接。

**权限规则** - 如何从关系推导出权限。比如"editor 自动拥有 viewer 权限"就是一条权限规则。

### 最简单的模型

让我们从最简单的例子开始：

```openfga
model
  schema 1.1

type user

type document
  relations
    define viewer: [user]
```

这个模型定义了两个类型（user 和 document），以及一个关系（viewer）。`[user]` 表示 viewer 关系只能赋值给 user 类型的实体。

**关系元组示例**：
```json
{
  "user": "user:alice",
  "relation": "viewer",
  "object": "document:report"
}
```

这表示"用户 alice 是文档 report 的查看者"。

### 权限继承

OpenFGA 的强大之处在于权限继承——你可以定义关系之间的包含关系：

```openfga
type document
  relations
    define owner: [user]
    define editor: [user] or owner
    define viewer: [user] or editor
```

这创建了权限层级：`owner` → `editor` → `viewer`。所有者自动拥有编辑和查看权限，编辑者自动拥有查看权限。

> **实践经验**：权限继承大大简化了权限管理。我在一个项目中，通过合理使用继承，将关系元组数量减少了 60%。不需要为每个用户显式创建所有关系，只需要创建核心关系，OpenFGA 会自动计算派生权限。

**完整模型示例**：参考 [文档所有权模型](../models/05.02.document-ownership/)

## 5.2 类型与关系设计

理解类型和关系的设计方法，是构建有效授权模型的关键。

### 类型设计原则

**用户类型** - `user` 类型通常不需要定义关系，因为用户是关系的主体而非对象：

```openfga
type user
```

**资源类型** - 需要权限控制的实体，必须定义关系：

```openfga
type document
  relations
    define owner: [user]
    define viewer: [user]
```

**中间类型** - 用于组织和分组，如 team、organization：

```openfga
type team
  relations
    define member: [user]
```

### 关系的类型

**直接关系** - 用户直接拥有某个关系：

```openfga
define viewer: [user]
```

**多类型关系** - 关系可以赋值给多种类型：

```openfga
define editor: [user, team#member]
```

这表示 editor 可以是直接用户，也可以是团队的所有成员。

**计算关系** - 通过其他关系推导：

```openfga
define viewer: [user] or editor
```

**对象间关系** - 从相关对象继承权限：

```openfga
type document
  relations
    define parent: [folder]
    define viewer: [user] or viewer from parent
```

文档可以从父文件夹继承 viewer 权限。

### 命名规范

好的命名让模型更易读易维护：

**类型命名**：
- 使用单数形式：`user` 而非 `users`
- 使用小写和下划线：`document_file` 而非 `DocumentFile`
- 保持描述性：`project_document` 而非 `pd`

**关系命名**：
- 角色关系用名词：`owner`、`editor`、`viewer`
- 权限关系用动词：`can_view`、`can_edit`、`can_delete`
- 保持一致性：在整个模型中使用统一的命名风格

> **踩坑经验**：我曾经在一个项目中混用了 `viewer` 和 `can_view` 两种命名风格，结果团队成员经常搞混。后来统一改成角色命名（viewer、editor、owner），代码清晰了很多。

**完整类型设计示例**：参考 [团队协作模型](../models/05.09.team-collaboration-advanced/)

## 5.3 常见授权模式

掌握常见的授权模式，可以快速应对大多数业务场景。

### 文件共享模式

最经典的场景——用户可以创建文档并分享给其他人：

```openfga
type document
  relations
    define owner: [user]
    define editor: [user] or owner
    define viewer: [user] or editor
```

**权限层级**：owner（完全控制）→ editor（编辑）→ viewer（查看）

**扩展：文件夹层级**

```openfga
type folder
  relations
    define parent: [folder]
    define viewer: [user] or viewer from parent

type document
  relations
    define parent: [folder]
    define viewer: [user] or viewer from parent
```

文档和文件夹都可以从父文件夹继承权限，支持无限层级。

**完整模型**：参考 [文件夹层级模型](../models/05.06.folder-full-hierarchy/)

### 团队协作模式

支持团队级别的权限授予：

```openfga
type team
  relations
    define member: [user]

type document
  relations
    define owner: [user]
    define editor: [user, team#member] or owner
    define viewer: [user, team#member] or editor
```

`team#member` 表示团队的所有成员。当你将团队授权为 editor 时，团队的所有成员自动获得编辑权限。

> **实际应用**：在一个企业文档系统中，我们用这个模式实现了部门级权限管理。将整个部门（team）授权为文档的 viewer，部门的所有成员自动获得查看权限。当有新员工加入部门时，只需要将其添加为团队成员，无需逐个授权文档。

**完整模型**：参考 [团队协作高级模型](../models/05.09.team-collaboration-advanced/)

### 多租户模式

SaaS 应用的核心需求——不同租户的数据完全隔离：

```openfga
type tenant
  relations
    define member: [user]

type document
  relations
    define tenant: [tenant]
    define owner: [user] or member from tenant
    define viewer: [user] or owner
```

每个文档属于一个租户，只有租户成员可以访问。

**层级组织结构**：

```openfga
type organization
  relations
    define member: [user]

type team
  relations
    define parent: [organization]
    define member: [user] or member from parent

type document
  relations
    define organization: [organization]
    define viewer: [user] or member from organization
```

团队继承组织的成员，文档可以被组织成员访问。

**完整模型**：参考 [多租户 SaaS 模型](../models/05.10.multi-tenant-basic/)

### GitHub 风格权限

复杂的层级权限系统：

```openfga
type organization
  relations
    define member: [user]
    define admin: [user]

type repo
  relations
    define owner: [organization]
    define admin: [user, team#member] or admin from owner
    define maintainer: [user, team#member] or admin
    define writer: [user, team#member] or maintainer
    define reader: [user, team#member] or writer or member from owner
```

这个模型实现了：
- 四级权限：admin → maintainer → writer → reader
- 组织级权限继承
- 团队成员授权

**完整模型**：参考 [GitHub 风格仓库模型](../models/05.14.github-style/)

## 5.4 AI 辅助模型设计

利用 AI 工具可以大幅提升授权模型的设计效率。

### 为什么用 AI

在实际项目中，设计授权模型往往需要：
- 深入理解业务需求
- 熟悉 OpenFGA 语法
- 考虑性能和可维护性
- 编写完整的测试用例

AI 工具（ChatGPT、Claude）可以帮助你：
- 快速将业务需求转化为模型
- 提供设计建议和最佳实践
- 生成测试用例
- 诊断和优化问题

> **实践经验**：我在一个项目中用 Claude 辅助设计授权模型，从需求分析到完成测试，原本需要 2 天的工作，4 小时就完成了。AI 不仅提供了模型代码，还给出了性能优化建议和潜在问题提醒。

### 使用 AI 的步骤

**第一步：准备需求描述**

清晰描述业务场景和权限需求：

```
我需要为文档管理系统设计权限模型：

实体类型：
- 用户（user）
- 文档（document）
- 文件夹（folder）
- 团队（team）

权限层级：
- 所有者（owner）：完全控制
- 编辑者（editor）：可编辑
- 查看者（viewer）：只读

特殊规则：
- 编辑者自动拥有查看权限
- 所有者自动拥有所有权限
- 文档可以继承父文件夹权限
- 团队成员可以被授权
```

**第二步：构建提示词**

```
你是 OpenFGA 授权模型设计专家。请基于以下需求设计模型：

[粘贴需求描述]

要求：
1. 使用 OpenFGA schema 1.1 语法
2. 包含完整的类型和关系定义
3. 实现权限继承
4. 提供 3-5 个示例关系元组
5. 指出可能的性能问题

请开始设计。
```

**第三步：审查和优化**

AI 生成的模型需要人工审查：
- ✅ 语法正确性
- ✅ 业务完整性
- ✅ 关系合理性
- ✅ 性能考虑
- ✅ 可维护性

**第四步：生成测试用例**

继续使用 AI 生成测试：

```
基于上面的模型，请生成完整的测试用例：

1. 正常场景测试（5个）
2. 权限继承测试（3个）
3. 边界情况测试（3个）
4. 权限拒绝场景（2个）

使用 OpenFGA 测试 YAML 格式。
```

### 提示词最佳实践

**提供明确上下文**：

❌ 不好：`帮我设计一个权限模型`

✅ 好：`我需要为 SaaS 多租户文档协作平台设计 OpenFGA 授权模型。平台有组织、团队、项目和文档四个层级，需要支持权限继承。请使用 schema 1.1 语法。`

**分步骤请求**：

```
第一步：请先设计基础模型
[AI 生成]

第二步：现在添加文件夹层级支持
[AI 生成]

第三步：请分析性能问题并优化
[AI 生成]
```

**迭代优化**：

```
用户：这个模型很好，但我担心 reader 关系的性能。
AI：建议将 reader 拆分为 explicit_reader 和 org_reader...
用户：请提供优化后的完整模型。
AI：[优化后的模型]
```

### AI 辅助调试

AI 还可以帮助诊断问题：

```
我的模型有问题：

## 模型定义
[粘贴模型]

## 问题现象
user:alice 应该能访问 document:report，但 check 返回 false

## 测试数据
- {user: "user:alice", relation: "viewer", object: "folder:project"}
- {user: "document:report", relation: "parent", object: "folder:project"}

请帮我分析问题。
```

AI 会指出：关系元组的方向错了，应该是 `{user: "folder:project", relation: "parent", object: "document:report"}`。

> **重要提醒**：AI 是辅助工具，不能完全替代人工。深入的业务理解、性能测试、安全评估，仍然需要人工完成。但合理使用 AI，确实能将效率提升 50% 以上。

## 5.5 开发工具使用

掌握开发工具，让模型开发事半功倍。

### VSCode 插件

VSCode OpenFGA 插件提供了强大的开发支持。

**安装**：
```bash
code --install-extension openfga.openfga-vscode
```

**核心功能**：

**语法高亮和智能提示** - `.fga` 文件自动获得语法高亮，编写时提供智能补全。

**实时验证** - 保存文件时自动验证语法，在 Problems 面板显示错误。

**代码格式化** - 使用 `Shift+Alt+F` 格式化模型。

**跳转和引用** - Ctrl+Click 跳转到定义，Shift+F12 查找引用。

**配置优化**：

在 `.vscode/settings.json` 中添加：

```json
{
  "files.associations": {
    "*.fga": "openfga"
  },
  "openfga.validate.onSave": true,
  "openfga.format.enable": true,
  "editor.formatOnSave": true
}
```

**代码片段**：

创建 `.vscode/openfga.code-snippets`：

```json
{
  "OpenFGA Basic Model": {
    "prefix": "fga-model",
    "body": [
      "model",
      "  schema 1.1",
      "",
      "type user",
      "",
      "type ${1:resource}",
      "  relations",
      "    define owner: [user]",
      "    define editor: [user] or owner",
      "    define viewer: [user] or editor"
    ]
  }
}
```

输入 `fga-model` 即可快速生成模板。

### CLI 工具详解

FGA CLI 是日常开发的核心工具。

**模型管理**：

```bash
# 验证模型语法
fga model validate --file model.fga

# 写入模型
fga model write --store-id $STORE_ID --file model.fga

# 读取模型
fga model get --store-id $STORE_ID

# 列出所有版本
fga model list --store-id $STORE_ID
```

**测试命令**：

```bash
# 运行测试
fga model test --tests tests/model.fga.yaml

# 测试特定场景
fga model test --tests tests/model.fga.yaml --filter "Owner permissions"
```

**权限检查**：

```bash
# 单次检查
fga query check user:alice viewer document:report

# 批量检查
fga query batch-check --file checks.json

# 列出用户可访问的对象
fga query list-objects --user user:alice --relation viewer --type document

# 列出可访问对象的用户
fga query list-users --object document:report --relation viewer
```

**配置文件**：

创建 `~/.fga.yaml` 避免重复输入参数：

```yaml
api-url: http://localhost:8080
store-id: 01HQXXX...
model-id: 01HQYYY...
format: json
```

**脚本化操作**：

创建测试脚本 `test-permissions.sh`：

```bash
#!/bin/bash
STORE_ID="01HQXXX..."

echo "Testing document permissions..."

fga query check --store-id $STORE_ID \
  user:alice owner document:report && echo "✓ Owner check passed"

fga query check --store-id $STORE_ID \
  user:bob editor document:report && echo "✓ Editor check passed"
```

**性能分析**：

使用 `--debug` 查看详细执行信息：

```bash
fga query check --debug user:alice viewer document:report

# 输出包含：
# - 查询执行时间
# - 遍历的关系路径
# - 数据库查询次数
```

> **实践技巧**：我在项目中创建了一套自动化测试脚本，每次修改模型后自动运行。这套脚本帮我发现了很多潜在问题，避免了将错误的模型部署到生产环境。

### 集成开发工作流

**开发阶段**：
1. 使用 VSCode 编写模型
2. 实时验证（VSCode 自动完成）
3. 本地测试：`fga model validate && fga model test`

**部署阶段**：
1. 创建新模型版本：`fga model write`
2. 验证部署：`fga model get`
3. 冒烟测试：运行测试脚本

**调试阶段**：
1. 检查权限：`fga query check --debug`
2. 列出关系：`fga tuple read`
3. 使用 AI 分析问题

## 5.6 模型测试与验证

测试确保模型的正确性和可靠性。

### 测试文件格式

创建 `tests/model.fga.yaml`：

```yaml
model_file: ../model.fga

tuples:
  - user: user:alice
    relation: owner
    object: document:report
  - user: user:bob
    relation: editor
    object: document:report

tests:
  - name: "Owner has all permissions"
    check:
      - user: user:alice
        object: document:report
        assertions:
          owner: true
          editor: true
          viewer: true

  - name: "Editor has viewer permission"
    check:
      - user: user:bob
        object: document:report
        assertions:
          editor: true
          viewer: true
          owner: false
```

### 测试用例设计

**覆盖正常场景**：

```yaml
- name: "Owner can view"
  check:
    - user: user:alice
      object: document:report
      assertions:
        viewer: true
```

**测试继承关系**：

```yaml
- name: "Editor inherits viewer"
  check:
    - user: user:alice
      object: document:report
      assertions:
        viewer: true  # 通过 editor 继承
```

**测试边界情况**：

```yaml
- name: "Unauthorized access denied"
  check:
    - user: user:unknown
      object: document:report
      assertions:
        viewer: false
```

**测试复杂场景**：

```yaml
- name: "Folder permission inherits to document"
  tuples:
    - user: user:alice
      relation: viewer
      object: folder:projects
    - user: folder:projects
      relation: parent
      object: document:report
  check:
    - user: user:alice
      object: document:report
      assertions:
        viewer: true
```

### 运行测试

```bash
# 运行所有测试
fga model test --tests tests/model.fga.yaml

# 输出：
# Running 4 tests...
# ✓ Owner has all permissions
# ✓ Editor has viewer permission
# ✓ Unauthorized access denied
# ✓ Folder permission inherits to document
```

> **测试经验**：我在项目中坚持"测试先行"原则——先写测试用例，再实现模型。这种方式帮我避免了很多设计缺陷，也让模型的演进更加安全。

## 5.7 性能优化策略

合理的模型设计可以避免性能问题。

### 常见性能陷阱

**过深的关系链**：

❌ 不好：
```openfga
type document
  relations
    define parent: [folder]
    define viewer: viewer from parent

type folder
  relations
    define parent: [folder]
    define viewer: viewer from parent  # 可能导致深层递归
```

✅ 好：
```openfga
type document
  relations
    define parent: [folder]
    define viewer: [user] or viewer from parent  # 允许直接授权
```

**复杂的关系组合**：

❌ 不好：
```openfga
define reader: [user] or writer or member from owner or admin from parent
```

✅ 好：拆分为多个关系，逐步组合。

### 优化策略

**减少查询深度** - 优先使用直接关系，减少计算用户集的嵌套。

**分离高频低频查询** - 将常用权限和罕见权限分开定义。

**使用缓存友好的设计** - 避免过长的关系链，让缓存更有效。

> **性能实践**：在一个大型项目中，我们通过优化模型设计，将平均查询时间从 80ms 降到了 15ms。主要优化点是减少了关系继承的层级，并将高频查询的权限提前到直接关系。

## 本章小结

本章深入讲解了 OpenFGA 授权模型的设计方法——从基础概念到高级模式，从手工设计到 AI 辅助。

**核心要点**：

1. 授权模型定义类型、关系和权限规则，是 OpenFGA 的核心
2. 权限继承简化模型，减少关系元组数量
3. 掌握常见模式（文件共享、团队协作、多租户）可快速应对业务需求
4. AI 工具大幅提升设计效率，但需要人工审查
5. VSCode 插件和 CLI 工具是日常开发的利器
6. 完善的测试确保模型质量
7. 合理设计避免性能陷阱

**关键收获**：

授权模型设计是一门需要实践的艺术。从简单模型开始，逐步添加功能，通过测试验证正确性，利用 AI 工具提升效率——这是我在实际项目中总结的最佳路径。

**下一步**：

在下一章中，我们将学习关系元组管理——如何在应用中创建、查询、删除关系元组，如何处理批量操作和性能优化。这将帮助你将设计好的授权模型付诸实践。

准备好了吗？让我们继续！

---

## 实践练习

### 基础练习

**1. 设计简单文档系统**

要求：
- 定义 user、document 类型
- 实现 owner、editor、viewer 三级权限
- 使用关系继承
- 编写测试用例

**2. 添加文件夹层级**

要求：
- 扩展文档模型，添加 folder 类型
- 实现文件夹层级结构
- 文档从父文件夹继承权限
- 测试多层继承

### 进阶练习

**3. 设计多租户 SaaS 平台**

要求：
- 支持租户数据隔离
- 组织和团队层级结构
- 资源属于组织
- 权限从组织/团队继承

**4. 使用 AI 设计 GitHub 风格权限**

要求：
- 使用 ChatGPT 或 Claude 设计
- 实现 organization、team、repo 层级
- 支持四级权限
- 提供完整提示词和结果

### 挑战练习

**5. 设计复杂企业级系统**

要求：
- 多层级组织（公司 → 部门 → 团队 → 项目）
- 支持角色和权限灵活组合
- 处理数万用户和百万级关系元组
- 性能目标：99% 查询在 50ms 内

**6. AI 辅助全流程实践**

要求：
- 使用 AI 完成需求分析 → 模型设计 → 测试生成 → 问题调试
- 记录完整对话过程
- 总结经验和技巧
- 识别 AI 的局限性

---

## 延伸阅读

**官方资源**：
- [OpenFGA 建模指南](https://openfga.dev/docs/modeling)
- [授权模型示例库](https://github.com/openfga/sample-stores)
- [OpenFGA Playground](https://play.fga.dev)
- [FGA CLI 文档](https://github.com/openfga/cli)

**AI 工具资源**：
- [ChatGPT 提示词库](https://github.com/f/awesome-chatgpt-prompts)
- [Claude 提示工程指南](https://docs.anthropic.com/claude/docs/prompt-engineering)

**学习建议**：
1. 实践为主 - 每学一个概念就动手实践
2. 善用 AI - 遇到问题先用 AI 辅助分析
3. 参考案例 - 多看官方示例和社区案例
4. 性能意识 - 设计时就考虑性能影响
5. 版本管理 - 使用版本控制管理模型变更

通过本章学习，你已经掌握了授权模型设计的核心知识。在下一章中，我们将学习如何管理关系元组，将设计好的模型付诸实践。
