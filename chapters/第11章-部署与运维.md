# 第 11 章：部署与运维

掌握 OpenFGA 在生产环境中的部署与运维

---

生产环境的部署与运维是确保 OpenFGA 授权系统高效、稳定、安全运行的关键环节。本章将介绍生产环境部署的最佳实践，帮助你构建企业级的授权系统基础设施。

## 11.1 部署架构选择

OpenFGA 作为一个无状态的授权服务，天然适合容器化和云原生部署。根据不同的业务规模和需求，可以选择不同的部署架构。

### 单实例部署

单实例部署适用于开发测试环境或小规模应用。

**适用场景**：
- 开发和测试环境
- 小规模生产应用（QPS < 100）
- 快速原型验证

**Docker Compose 部署**：

```yaml
version: "3.8"
services:
  openfga:
    image: openfga/openfga:latest
    environment:
      - OPENFGA_DATASTORE_ENGINE=postgres
      - OPENFGA_DATASTORE_URI=postgres://fga:password@postgres:5432/fga
    ports:
      - "8080:8080"
    depends_on:
      - postgres

  postgres:
    image: postgres:17
    environment:
      - POSTGRES_DB=fga
    volumes:
      - postgres_data:/var/lib/postgresql/data
```

> **实践经验**：我第一次部署 OpenFGA 时，直接用 Docker Compose 在单台服务器上跑。结果上线第一天就因为数据库连接数不够导致服务挂了。后来才知道要配置连接池和资源限制。

### 高可用部署

高可用部署通过多实例、负载均衡和数据库集群确保系统的高可用性。

**架构组成**：
- OpenFGA 服务层：多个实例，通过负载均衡器分发流量
- 数据库层：主从复制或集群模式
- 负载均衡器：分发请求并实现健康检查
- 监控和日志：集中式监控和日志收集

**Kubernetes 部署**：

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: openfga
spec:
  replicas: 3
  selector:
    matchLabels:
      app: openfga
  template:
    metadata:
      labels:
        app: openfga
    spec:
      containers:
      - name: openfga
        image: openfga/openfga:latest
        ports:
        - containerPort: 8080
        env:
        - name: OPENFGA_DATASTORE_ENGINE
          value: "postgres"
```

**完整部署配置**：参考 [Go 微服务集成](../integrates/08.go-microservice/deployment/)

## 11.2 容器化部署

容器化是现代应用部署的标准方式。OpenFGA 提供了官方的 Docker 镜像，支持多种部署场景。

### Docker 部署

**基本启动命令**：

```bash
docker run -d \
  --name openfga \
  -p 8080:8080 \
  -e OPENFGA_DATASTORE_ENGINE=postgres \
  -e OPENFGA_DATASTORE_URI=postgres://user:pass@host:5432/fga \
  openfga/openfga:latest run
```

**环境变量配置**：

关键配置项包括：
- `OPENFGA_DATASTORE_ENGINE` - 存储引擎（postgres/mysql/memory）
- `OPENFGA_DATASTORE_URI` - 数据库连接字符串
- `OPENFGA_LOG_LEVEL` - 日志级别（debug/info/warn/error）
- `OPENFGA_METRICS_ENABLED` - 是否启用指标（true/false）
- `OPENFGA_PLAYGROUND_ENABLED` - 是否启用 Playground（生产环境建议关闭）

### Kubernetes 部署

Kubernetes 是生产环境的首选部署方式。

**核心资源**：
- Deployment - 管理 OpenFGA 实例
- Service - 提供负载均衡
- ConfigMap - 管理配置
- Secret - 管理敏感信息
- HPA - 自动扩缩容

**健康检查配置**：

```yaml
livenessProbe:
  httpGet:
    path: /healthz
    port: 8080
  initialDelaySeconds: 30
  periodSeconds: 10

readinessProbe:
  httpGet:
    path: /healthz
    port: 8080
  initialDelaySeconds: 5
  periodSeconds: 5
```

> **踩坑经验**：一定要配置 readinessProbe！我之前没配置，结果新实例还没启动完成就开始接收流量，导致大量请求失败。配置 readinessProbe 后，Kubernetes 会等实例完全就绪才转发流量。

**完整 Kubernetes 配置**：参考 [Go 微服务集成](../integrates/08.go-microservice/k8s/)

## 11.3 监控与告警

监控是保障系统稳定运行的关键。OpenFGA 集成了 Prometheus，可以方便地接入监控系统。

### Prometheus 监控

OpenFGA 在 `:2112/metrics` 端点暴露 Prometheus 格式的指标。

**关键指标**：
- `openfga_request_duration_seconds` - 请求延迟
- `openfga_request_total` - 请求总数
- `openfga_datastore_query_duration_seconds` - 数据库查询延迟
- `openfga_cache_hit_total` - 缓存命中数
- `openfga_cache_miss_total` - 缓存未命中数

**Prometheus 配置**：

```yaml
scrape_configs:
  - job_name: 'openfga'
    static_configs:
      - targets: ['openfga:2112']
    scrape_interval: 15s
```

### Grafana 仪表板

Grafana 提供可视化的监控面板。

**核心面板**：
- 请求速率和延迟
- 错误率趋势
- 数据库性能
- 缓存命中率
- 资源使用情况（CPU、内存）

> **实践经验**：我建议设置以下告警规则：
> - P99 延迟超过 100ms
> - 错误率超过 1%
> - 缓存命中率低于 70%
> - 数据库连接数超过 80%
>
> 这些阈值是我在生产环境中总结出来的，可以及时发现问题。

### 日志管理

OpenFGA 支持结构化日志输出，便于日志收集和分析。

**日志配置**：

```bash
OPENFGA_LOG_FORMAT=json
OPENFGA_LOG_LEVEL=info
```

**日志收集方案**：
- ELK Stack（Elasticsearch + Logstash + Kibana）
- Loki + Grafana
- CloudWatch Logs（AWS）
- Cloud Logging（GCP）

**完整监控配置**：参考 [Go 微服务集成](../integrates/08.go-microservice/monitoring/)

## 11.4 备份与恢复

数据备份是保障数据安全的最后一道防线。

### 数据库备份

OpenFGA 的数据存储在数据库中，备份策略主要针对数据库。

**PostgreSQL 备份**：

```bash
# 全量备份
pg_dump -h localhost -U fga -d fga > backup.sql

# 恢复
psql -h localhost -U fga -d fga < backup.sql
```

**备份策略**：
- 每日全量备份
- 每小时增量备份（如果支持）
- 保留最近 7 天的备份
- 异地备份（防止机房故障）

### 授权模型备份

授权模型也需要定期备份。

**导出授权模型**：

```bash
fga model get --store-id ${STORE_ID} > model.fga
```

**导出关系元组**：

```bash
fga tuple read --store-id ${STORE_ID} --max-pages 100 > tuples.json
```

> **踩坑经验**：我曾经遇到过一次误操作，删除了生产环境的授权模型。幸好有备份，才能快速恢复。所以一定要定期备份，并且测试恢复流程！

## 11.5 故障排查

生产环境难免会遇到问题，掌握故障排查方法很重要。

### 常见问题排查

**问题 1：请求延迟高**

排查步骤：
1. 检查数据库性能（慢查询、连接数）
2. 检查缓存命中率
3. 检查网络延迟
4. 检查授权模型复杂度

**问题 2：服务不可用**

排查步骤：
1. 检查服务是否运行（`docker ps` 或 `kubectl get pods`）
2. 检查健康检查端点（`curl http://localhost:8080/healthz`）
3. 检查数据库连接
4. 查看日志（`docker logs` 或 `kubectl logs`）

**问题 3：权限检查返回错误结果**

排查步骤：
1. 验证授权模型是否正确
2. 检查关系元组是否存在
3. 使用 Expand API 查看权限路径
4. 检查 Model ID 是否正确

### 日志分析

OpenFGA 的结构化日志包含丰富的信息。

**关键日志字段**：
- `level` - 日志级别
- `msg` - 日志消息
- `method` - API 方法
- `duration` - 请求耗时
- `error` - 错误信息

**日志查询示例**：

```bash
# 查询错误日志
kubectl logs -l app=openfga | grep '"level":"error"'

# 查询慢请求
kubectl logs -l app=openfga | grep '"duration"' | awk '$NF > 100'
```

## 11.6 安全加固

生产环境的安全至关重要。

### 网络安全

**最佳实践**：
- 使用 HTTPS/TLS 加密通信
- 配置防火墙规则，只开放必要端口
- 使用 VPC 或私有网络隔离
- 配置 API 网关进行访问控制

### 认证与授权

**API 认证**：

```yaml
# 配置 Bearer Token 认证
OPENFGA_AUTHN_METHOD=preshared
OPENFGA_AUTHN_PRESHARED_KEYS=key1,key2
```

**访问控制**：
- 使用 API 网关进行认证
- 配置 IP 白名单
- 实施最小权限原则
- 定期轮换密钥

### 数据安全

**最佳实践**：
- 数据库连接使用 TLS
- 敏感信息使用 Secret 管理
- 定期备份数据
- 实施数据加密（静态和传输）

> **安全建议**：生产环境一定要关闭 Playground（`OPENFGA_PLAYGROUND_ENABLED=false`）。Playground 虽然方便，但会暴露授权模型和数据，存在安全风险。

## 11.7 CI/CD 集成

自动化部署可以提高效率和可靠性。

### GitHub Actions

**部署流程**：

```yaml
name: Deploy OpenFGA
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build Docker image
        run: docker build -t openfga:${{ github.sha }} .

      - name: Push to registry
        run: docker push openfga:${{ github.sha }}

      - name: Deploy to Kubernetes
        run: kubectl set image deployment/openfga openfga=openfga:${{ github.sha }}
```

### 部署策略

**滚动更新**：
- 逐步替换旧实例
- 零停机部署
- 可以随时回滚

**蓝绿部署**：
- 维护两套环境
- 快速切换
- 安全可靠

**金丝雀发布**：
- 先发布到小部分实例
- 观察指标
- 逐步扩大范围

**完整 CI/CD 配置**：参考 [Go 微服务集成](../integrates/08.go-microservice/.github/workflows/)

## 本章小结

本章介绍了 OpenFGA 在生产环境中的部署与运维最佳实践。

**核心要点**：

1. 根据业务规模选择合适的部署架构（单实例或高可用）
2. 使用容器化部署（Docker 或 Kubernetes）
3. 配置完善的监控告警系统（Prometheus + Grafana）
4. 实施数据备份策略，定期测试恢复流程
5. 掌握故障排查方法，快速定位和解决问题
6. 加强安全防护，保护系统和数据安全
7. 使用 CI/CD 实现自动化部署

**关键收获**：

生产环境的部署与运维是一个系统工程，需要考虑高可用、性能、安全、可观测性等多个方面。通过合理的架构设计、完善的监控告警、可靠的备份恢复和自动化的部署流程，可以构建一个稳定、高效、安全的 OpenFGA 授权系统。

**下一步**：

在下一章中，我们将学习企业级应用实践案例——通过真实的业务场景，了解如何在实际项目中应用 OpenFGA，解决复杂的权限管理问题。

准备好了吗？让我们继续！
